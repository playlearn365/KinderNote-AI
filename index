import React, { useState, useEffect, useRef } from 'react';
import { 
  BookOpen, 
  Sun, 
  Activity, 
  Stethoscope, 
  HeartHandshake, 
  Bell, 
  ChevronRight, 
  Sparkles, 
  RotateCcw, 
  Copy, 
  Check,
  Edit3,
  MessageCircle,
  Feather
} from 'lucide-react';

/* 核心配置：聯絡簿類型與隱藏的語氣安全設定 
  這是系統的靈魂，老師看不到，但 AI 會依據此邏輯生成。
*/
const RECORD_TYPES = [
  {
    id: 'daily',
    label: '日常生活紀錄',
    icon: <Sun size={24} />,
    color: 'bg-green-100 text-green-700 border-green-200',
    promptContext: '語氣輕快、溫馨。重點在於分享孩子在校的可愛日常，讓家長感到放心。描述事實即可。'
  },
  {
    id: 'activity',
    label: '活動／學習分享',
    icon: <Activity size={24} />,
    color: 'bg-yellow-100 text-yellow-700 border-yellow-200',
    promptContext: '語氣充滿活力與鼓勵。強調孩子的參與過程與探索精神，而不是成果的好壞。'
  },
  {
    id: 'health',
    label: '身體狀況回饋',
    icon: <Stethoscope size={24} />,
    color: 'bg-blue-100 text-blue-700 border-blue-200',
    promptContext: '語氣客觀、關懷但冷靜。只描述觀察到的生理現象（如體溫、食慾、排便），絕對不進行醫療診斷，不使用驚悚字眼。'
  },
  {
    id: 'emotion',
    label: '情緒／行為觀察',
    icon: <HeartHandshake size={24} />,
    color: 'bg-orange-100 text-orange-700 border-orange-200',
    promptContext: '語氣中性、溫和、具備同理心。採用「三明治溝通法」（肯定-觀察-支持）。避免負面標籤（如：不乖、調皮），改用行為描述（如：還在練習控制力氣）。'
  },
  {
    id: 'reminder',
    label: '提醒／補充說明',
    icon: <Bell size={24} />,
    color: 'bg-red-100 text-red-700 border-red-200',
    promptContext: '語氣禮貌、感謝。清楚說明需要家長配合的事項，並感謝家長的協助。'
  }
];

const MODIFIERS = [
  { label: '改短一點', prompt: '請將上述內容精簡，保留核心重點即可，字數減少 30%。' },
  { label: '再口語一點', prompt: '請將語氣變得更像像朋友聊天一樣輕鬆，減少書面用語。' },
  { label: '語氣更溫柔', prompt: '請加入更多溫暖、關懷的語氣詞，讓家長讀起來覺得很被支持。' },
  { label: '強調孩子進步', prompt: '請在內容中特別強調孩子做得好的地方，給予正向鼓勵。' },
];

export default function ContactBookAI() {
  const [step, setStep] = useState(1); // 1: 選類型, 2: 輸入重點, 3: 生成結果
  const [selectedType, setSelectedType] = useState(null);
  const [inputPoints, setInputPoints] = useState('');
  const [generatedText, setGeneratedText] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [history, setHistory] = useState([]); // 簡單的歷史紀錄 (本次 Session)
  const [copied, setCopied] = useState(false);
  const resultRef = useRef(null);

  // API Key handling (Environment simulation)
  const apiKey = ""; 

  const handleTypeSelect = (type) => {
    setSelectedType(type);
    setStep(2);
  };

  const generateContent = async (customPrompt = null) => {
    if (!inputPoints.trim() && !generatedText) return;
    
    setIsLoading(true);
    setCopied(false);

    try {
      const typeConfig = RECORD_TYPES.find(t => t.id === selectedType.id);
      
      // 建構 System Prompt (核心原則)
      const systemInstruction = `
        你是一位專業、溫暖且富有同理心的幼兒園老師助理。你的任務是協助老師將零散的「觀察重點」轉換為寫給家長的「聯絡簿短文」。
        
        【最高指導原則】：
        1. **事實轉譯**：老師給事實，你幫忙潤飾。不無中生有。
        2. **不做評判**：絕不替老師下結論，不判斷孩子好壞，不貼標籤。
        3. **安全溫和**：以孩子成長為主軸，語氣讓家長安心，不是緊張。避免使用專業術語或醫療診斷。
        4. **格式要求**：分段清晰，適合手機閱讀，像真人寫的，不要像機器人。

        【當前情境】：${typeConfig.label}
        【語氣設定】：${typeConfig.promptContext}
      `;

      let userQuery = "";
      if (customPrompt) {
        // 微調模式
        userQuery = `這是目前的聯絡簿草稿：\n"${generatedText}"\n\n請根據以下需求進行修改：${customPrompt}`;
      } else {
        // 初始生成模式
        userQuery = `請將以下重點擴寫成一篇聯絡簿短文：\n\n${inputPoints}`;
      }

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] }
          }),
        }
      );

      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error.message);
      }

      const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
      setGeneratedText(result);
      if(step !== 3) setStep(3);

    } catch (error) {
      console.error("Error generating text:", error);
      alert("抱歉，生成時發生錯誤，請稍後再試。");
    } finally {
      setIsLoading(false);
    }
  };

  const handleCopy = () => {
    // 使用 document.execCommand 作為備用方案，解決 iframe 中 Permissions Policy 阻擋 clipboard API 的問題
    const textArea = document.createElement("textarea");
    textArea.value = generatedText;
    
    // 確保 textArea 不會影響畫面佈局
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
      const successful = document.execCommand('copy');
      if (successful) {
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      } else {
        console.error('Fallback: Copying text command was unsuccessful');
      }
    } catch (err) {
      console.error('Fallback: Oops, unable to copy', err);
    }
    
    document.body.removeChild(textArea);
  };

  const reset = () => {
    setStep(1);
    setSelectedType(null);
    setInputPoints('');
    setGeneratedText('');
  };

  // 渲染步驟 1: 選擇類型
  const renderStep1 = () => (
    <div className="space-y-4 animate-fadeIn">
      <h2 className="text-xl font-bold text-gray-800 mb-2 flex items-center">
        <BookOpen className="mr-2 text-indigo-600" />
        請問今天要寫哪一類？
      </h2>
      <p className="text-gray-500 text-sm mb-4">點擊下方類型，AI 會自動調整合適語氣</p>
      
      <div className="grid grid-cols-1 gap-3">
        {RECORD_TYPES.map((type) => (
          <button
            key={type.id}
            onClick={() => handleTypeSelect(type)}
            className={`w-full text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center justify-between group active:scale-95 ${type.color} hover:brightness-95 border-transparent hover:border-current`}
          >
            <div className="flex items-center">
              <div className="p-2 bg-white/50 rounded-full mr-3">
                {type.icon}
              </div>
              <span className="font-bold text-lg">{type.label}</span>
            </div>
            <ChevronRight className="opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
          </button>
        ))}
      </div>
    </div>
  );

  // 渲染步驟 2: 輸入重點
  const renderStep2 = () => (
    <div className="animate-fadeIn flex flex-col h-full">
      <div className="flex items-center mb-4">
        <button onClick={() => setStep(1)} className="p-2 -ml-2 text-gray-400 hover:text-gray-600">
          <ChevronRight className="rotate-180" />
        </button>
        <h2 className="text-xl font-bold text-gray-800 ml-1">
          {selectedType?.label}
        </h2>
      </div>

      <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-4 flex-grow">
        <div className="flex items-start mb-3">
          <Edit3 size={18} className="text-indigo-500 mt-1 mr-2" />
          <div>
            <label className="block text-gray-700 font-bold mb-1">今天的重點是？</label>
            <p className="text-xs text-gray-400">不用完整句子，條列式輸入即可。</p>
          </div>
        </div>
        
        <textarea
          className="w-full h-48 p-3 bg-gray-50 rounded-lg border border-gray-200 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300 resize-none text-base leading-relaxed"
          placeholder={`例如：
- 戶外活動跑得很快
- 午餐吃了兩碗
- 和同學分享玩具
- 午睡時有點想媽媽`}
          value={inputPoints}
          onChange={(e) => setInputPoints(e.target.value)}
        />
      </div>

      <button
        onClick={() => generateContent()}
        disabled={!inputPoints.trim() || isLoading}
        className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg flex items-center justify-center transition-all
          ${!inputPoints.trim() ? 'bg-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-indigo-500 to-purple-600 hover:shadow-xl active:scale-95'}
        `}
      >
        {isLoading ? (
          <>
            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
            正在為您撰寫...
          </>
        ) : (
          <>
            <Sparkles className="mr-2" />
            生成聯絡簿文字
          </>
        )}
      </button>
    </div>
  );

  // 渲染步驟 3: 生成結果與微調
  const renderStep3 = () => (
    <div className="animate-fadeIn flex flex-col h-full">
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center">
          <button onClick={() => setStep(2)} className="p-2 -ml-2 text-gray-400 hover:text-gray-600">
            <ChevronRight className="rotate-180" />
          </button>
          <span className="text-gray-500 text-sm">回到編輯</span>
        </div>
        <button onClick={reset} className="text-sm text-indigo-600 font-medium flex items-center hover:bg-indigo-50 px-2 py-1 rounded">
          <RotateCcw size={14} className="mr-1" /> 新的一則
        </button>
      </div>

      {/* 結果顯示區 */}
      <div className="bg-white rounded-xl shadow-md border border-indigo-100 overflow-hidden mb-4 relative flex-grow flex flex-col">
        <div className="bg-indigo-50 px-4 py-2 border-b border-indigo-100 flex justify-between items-center">
          <div className="flex items-center text-indigo-800 font-bold text-sm">
            <Feather size={14} className="mr-2" />
            AI 助理建議
          </div>
          <button 
            onClick={handleCopy}
            className={`flex items-center text-xs px-3 py-1.5 rounded-full transition-colors ${copied ? 'bg-green-100 text-green-700' : 'bg-white text-gray-600 hover:bg-gray-100 border'}`}
          >
            {copied ? <Check size={12} className="mr-1" /> : <Copy size={12} className="mr-1" />}
            {copied ? '已複製' : '複製文字'}
          </button>
        </div>
        
        <div className="p-4 overflow-y-auto flex-grow bg-white">
          {isLoading ? (
             <div className="flex flex-col items-center justify-center h-full text-gray-400 space-y-3">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                <p className="text-sm">正在依照您的需求調整...</p>
             </div>
          ) : (
            <div 
              ref={resultRef}
              className="prose prose-sm max-w-none text-gray-700 whitespace-pre-line leading-relaxed text-base"
            >
              {generatedText}
            </div>
          )}
        </div>
      </div>

      {/* 微調按鈕區 */}
      <div className="space-y-2">
        <p className="text-xs text-gray-400 font-medium ml-1">快速微調（不滿意可以直接點）</p>
        <div className="grid grid-cols-2 gap-2">
          {MODIFIERS.map((mod, idx) => (
            <button
              key={idx}
              disabled={isLoading}
              onClick={() => generateContent(mod.prompt)}
              className="bg-white border border-gray-200 text-gray-600 py-2.5 px-3 rounded-lg text-sm font-medium hover:bg-gray-50 hover:border-indigo-200 hover:text-indigo-600 transition-all shadow-sm active:scale-95 disabled:opacity-50"
            >
              {mod.label}
            </button>
          ))}
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-900 flex justify-center">
      {/* 手機尺寸模擬容器 */}
      <div className="w-full max-w-md bg-white min-h-screen sm:min-h-0 sm:h-[850px] sm:my-8 sm:rounded-[2rem] sm:shadow-2xl sm:border-[8px] sm:border-gray-800 relative overflow-hidden flex flex-col">
        
        {/* 手機頂部裝飾 (僅在 Desktop 模式顯示) */}
        <div className="hidden sm:block absolute top-0 left-1/2 transform -translate-x-1/2 w-32 h-6 bg-gray-800 rounded-b-xl z-50"></div>

        {/* Header */}
        <header className="bg-white px-6 py-5 border-b border-gray-100 flex items-center justify-between sticky top-0 z-10">
          <div className="flex items-center space-x-2 pt-2 sm:pt-4">
            <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg">
              <MessageCircle size={24} fill="currentColor" className="text-white" />
            </div>
            <div>
              <h1 className="text-lg font-extrabold text-gray-800 leading-tight">聯絡簿 AI 助手</h1>
              <p className="text-xs text-gray-400">老師的省時好夥伴</p>
            </div>
          </div>
        </header>

        {/* Main Content Area */}
        <main className="flex-grow p-6 overflow-y-auto bg-[#F9FAFB]">
          {step === 1 && renderStep1()}
          {step === 2 && renderStep2()}
          {step === 3 && renderStep3()}
        </main>

        {/* Footer info */}
        <footer className="p-4 text-center text-xs text-gray-300 bg-white border-t border-gray-50">
          <p>AI 輔助內容僅供參考，請老師確認後再發送</p>
        </footer>
      </div>
    </div>
  );
}
